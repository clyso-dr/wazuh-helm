{{- if .Values.indexer.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "wazuh.indexer.fullname" . }}-securityconfig
  namespace: {{ .Release.Namespace }}
type: Opaque
stringData:
  internal_users.yml: |-
    ---
    # This is the internal user database
    # The hash value is a bcrypt hash and can be generated with plugin/tools/hash.sh

    _meta:
      type: "internalusers"
      config_version: 2

    # Define your internal users here

    ## Demo users
    admin:
      hash: "{{ include "wazuh.indexer.passwordHash" . }}"
      reserved: true
      backend_roles:
        - "admin"
      description: "Demo admin user"

    {{ include "wazuh.dashboard.username" . }}:
      hash: "{{ include "wazuh.dashboard.passwordHash" . }}"
      reserved: true
      description: "Demo {{ include "wazuh.dashboard.username" . }} user"

    kibanaro:
      hash: "$2a$12$JJSXNfTowz7Uu5ttXfeYpeYE0arACvcwlPBStB1F.MI7f0U9Z4DGC"
      reserved: false
      backend_roles:
        - "kibanauser"
        - "readall"
      attributes:
        attribute1: "value1"
        attribute2: "value2"
        attribute3: "value3"
      description: "Demo kibanaro user"

    logstash:
      hash: "$2a$12$u1ShR4l4uBS3Uv59Pa2y5.1uQuZBrZtmNfqB3iM/.jL0XoV9sghS2"
      reserved: false
      backend_roles:
        - "logstash"
      description: "Demo logstash user"

    readall:
      hash: "$2a$12$ae4ycwzwvLtZxwZ82RmiEunBbIPiAmGZduBAjKN0TXdwQFtCwARz2"
      reserved: false
      backend_roles:
        - "readall"
      description: "Demo readall user"

    snapshotrestore:
      hash: "$2y$12$DpwmetHKwgYnorbgdvORCenv4NAK8cPUg8AI6pxLCuWf/ALc0.v7W"
      reserved: false
      backend_roles:
        - "snapshotrestore"
      description: "Demo snapshotrestore user"

  roles_mapping.yml: |-
    ---
    # In this file users, backendroles and hosts can be mapped to Open Distro Security roles.
    # Permissions for Opendistro roles are configured in roles.yml

    _meta:
      type: "rolesmapping"
      config_version: 2

    ## Default roles mapping
    all_access:
      reserved: true
      hidden: false
      backend_roles:
        - "admin"
    {{- if and .Values.indexer.ldap.roleMappings .Values.indexer.ldap.roleMappings.allAccess.backendRoles }}
        {{- toYaml .Values.indexer.ldap.roleMappings.allAccess.backendRoles | nindent 8 }}
    {{- end }}
    {{- if and .Values.dashboard.sso.oidc.roleMappings .Values.dashboard.sso.oidc.roleMappings.allAccess.backendRoles }}
        {{- toYaml .Values.dashboard.sso.oidc.roleMappings.allAccess.backendRoles | nindent 8 }}
    {{- end }}
    {{- if and .Values.dashboard.sso.saml.roleMappings .Values.dashboard.sso.saml.roleMappings.allAccess.backendRoles }}
        {{- toYaml .Values.dashboard.sso.saml.roleMappings.allAccess.backendRoles | nindent 8 }}
    {{- end }}
      hosts: []
      users: []
      and_backend_roles: []
      description: "Maps admin to all_access"

    own_index:
      reserved: false
      hidden: false
      backend_roles: []
      hosts: []
      users:
        - "*"
      and_backend_roles: []
      description: "Allow full access to an index named like the username"

    logstash:
      reserved: false
      hidden: false
      backend_roles:
        - "logstash"
      hosts: []
      users: []
      and_backend_roles: []

    readall:
      reserved: true
      hidden: false
      backend_roles:
        - "readall"
    {{- if and .Values.indexer.ldap.roleMappings .Values.indexer.ldap.roleMappings.readall.backendRoles }}
        {{- toYaml .Values.indexer.ldap.roleMappings.readall.backendRoles | nindent 8 }}
    {{- end }}
      hosts: []
      users: []
      and_backend_roles: []

    manage_snapshots:
      reserved: true
      hidden: false
      backend_roles:
        - "snapshotrestore"
    {{- if and .Values.indexer.ldap.roleMappings .Values.indexer.ldap.roleMappings.manageSnapshots.backendRoles }}
        {{- toYaml .Values.indexer.ldap.roleMappings.manageSnapshots.backendRoles | nindent 8 }}
    {{- end }}
      hosts: []
      users: []
      and_backend_roles: []

    kibana_server:
      reserved: true
      hidden: false
      {{- $ldapKS := and .Values.indexer.ldap.roleMappings .Values.indexer.ldap.roleMappings.kibanaServer.backendRoles }}
      {{- $oidcKS := and .Values.dashboard.sso.oidc.roleMappings .Values.dashboard.sso.oidc.roleMappings.kibanaServer.backendRoles }}
      {{- $samlKS := and .Values.dashboard.sso.saml.roleMappings .Values.dashboard.sso.saml.roleMappings.kibanaServer.backendRoles }}
      backend_roles:{{ if not (or $ldapKS $oidcKS $samlKS) }} []{{ end }}
    {{- if $ldapKS }}
        {{- toYaml .Values.indexer.ldap.roleMappings.kibanaServer.backendRoles | nindent 8 }}
    {{- end }}
    {{- if $oidcKS }}
        {{- toYaml .Values.dashboard.sso.oidc.roleMappings.kibanaServer.backendRoles | nindent 8 }}
    {{- end }}
    {{- if $samlKS }}
        {{- toYaml .Values.dashboard.sso.saml.roleMappings.kibanaServer.backendRoles | nindent 8 }}
    {{- end }}
      hosts: []
      users:
        - "{{ include "wazuh.dashboard.username" . }}"
      and_backend_roles: []

    kibana_user:
      reserved: false
      hidden: false
      backend_roles:
        - "kibanauser"
    {{- if and .Values.indexer.ldap.roleMappings .Values.indexer.ldap.roleMappings.kibanaUser.backendRoles }}
        {{- toYaml .Values.indexer.ldap.roleMappings.kibanaUser.backendRoles | nindent 8 }}
    {{- end }}
    {{- if and .Values.dashboard.sso.oidc.roleMappings .Values.dashboard.sso.oidc.roleMappings.kibanaUser.backendRoles }}
        {{- toYaml .Values.dashboard.sso.oidc.roleMappings.kibanaUser.backendRoles | nindent 8 }}
    {{- end }}
    {{- if and .Values.dashboard.sso.saml.roleMappings .Values.dashboard.sso.saml.roleMappings.kibanaUser.backendRoles }}
        {{- toYaml .Values.dashboard.sso.saml.roleMappings.kibanaUser.backendRoles | nindent 8 }}
    {{- end }}
      hosts: []
      users: []
      and_backend_roles: []
      description: "Maps kibanauser to kibana_user"

    # Wazuh monitoring and statistics index permissions
    manage_wazuh_index:
      reserved: true
      hidden: false
      {{- $ldapMW := and .Values.indexer.ldap.roleMappings .Values.indexer.ldap.roleMappings.manageWazuhIndex.backendRoles }}
      backend_roles:{{ if not $ldapMW }} []{{ end }}
    {{- if $ldapMW }}
        {{- toYaml .Values.indexer.ldap.roleMappings.manageWazuhIndex.backendRoles | nindent 8 }}
    {{- end }}
      hosts: []
      users:
        - "{{ include "wazuh.dashboard.username" . }}"
      and_backend_roles: []

    # Extra Role Mappings for custom roles
    {{- if and .Values.indexer.ldap .Values.indexer.ldap.extraRoleMappings }}
    {{- toYaml .Values.indexer.ldap.extraRoleMappings | nindent 4 }}
    {{- end }}

    {{- if and .Values.dashboard.sso.oidc .Values.dashboard.sso.oidc.extraRoleMappings }}
    {{- toYaml .Values.dashboard.sso.oidc.extraRoleMappings | nindent 4 }}
    {{- end }}

    {{- if and .Values.dashboard.sso.saml .Values.dashboard.sso.saml.extraRoleMappings }}
    {{- toYaml .Values.dashboard.sso.saml.extraRoleMappings | nindent 4 }}
    {{- end }}

  roles.yml: |-
    _meta:
      type: "roles"
      config_version: 2

    # Restrict users so they can only view visualization and dashboard on OpenSearchDashboards
    kibana_read_only:
      reserved: true

    # The security REST API access role is used to assign specific users access to change the security settings through the REST API.
    security_rest_api_access:
      reserved: true

    security_rest_api_full_access:
      reserved: true
      cluster_permissions:
        - 'restapi:admin/actiongroups'
        - 'restapi:admin/allowlist'
        - 'restapi:admin/config/update'
        - 'restapi:admin/internalusers'
        - 'restapi:admin/nodesdn'
        - 'restapi:admin/roles'
        - 'restapi:admin/rolesmapping'
        - 'restapi:admin/ssl/certs/info'
        - 'restapi:admin/ssl/certs/reload'
        - 'restapi:admin/tenants'

    # Allows users to view monitors, destinations and alerts
    alerting_read_access:
      reserved: true
      cluster_permissions:
        - 'cluster:admin/opendistro/alerting/alerts/get'
        - 'cluster:admin/opendistro/alerting/destination/get'
        - 'cluster:admin/opendistro/alerting/monitor/get'
        - 'cluster:admin/opendistro/alerting/monitor/search'
        - 'cluster:admin/opensearch/alerting/findings/get'
        - 'cluster:admin/opensearch/alerting/workflow/get'
        - 'cluster:admin/opensearch/alerting/workflow_alerts/get'

    # Allows users to view and acknowledge alerts
    alerting_ack_alerts:
      reserved: true
      cluster_permissions:
        - 'cluster:admin/opendistro/alerting/alerts/*'
        - 'cluster:admin/opendistro/alerting/chained_alerts/*'
        - 'cluster:admin/opendistro/alerting/workflow_alerts/*'

    # Allows users to use all alerting functionality
    alerting_full_access:
      reserved: true
      cluster_permissions:
        - 'cluster_monitor'
        - 'cluster:admin/opendistro/alerting/*'
        - 'cluster:admin/opensearch/alerting/*'
        - 'cluster:admin/opensearch/notifications/feature/publish'
      index_permissions:
        - index_patterns:
            - '*'
          allowed_actions:
            - 'indices_monitor'
            - 'indices:admin/aliases/get'
            - 'indices:admin/mappings/get'

    # Allow users to read Anomaly Detection detectors and results
    anomaly_read_access:
      reserved: true
      cluster_permissions:
        - 'cluster:admin/opendistro/ad/detector/info'
        - 'cluster:admin/opendistro/ad/detector/search'
        - 'cluster:admin/opendistro/ad/detectors/get'
        - 'cluster:admin/opendistro/ad/result/search'
        - 'cluster:admin/opendistro/ad/tasks/search'
        - 'cluster:admin/opendistro/ad/detector/validate'
        - 'cluster:admin/opendistro/ad/result/topAnomalies'

    # Allows users to use all Anomaly Detection functionality
    anomaly_full_access:
      reserved: true
      cluster_permissions:
        - 'cluster_monitor'
        - 'cluster:admin/opendistro/ad/*'
      index_permissions:
        - index_patterns:
            - '*'
          allowed_actions:
            - 'indices_monitor'
            - 'indices:admin/aliases/get'
            - 'indices:admin/mappings/get'

    # Allow users to execute read only k-NN actions
    knn_read_access:
      reserved: true
      cluster_permissions:
        - 'cluster:admin/knn_search_model_action'
        - 'cluster:admin/knn_get_model_action'
        - 'cluster:admin/knn_stats_action'

    # Allow users to use all k-NN functionality
    knn_full_access:
      reserved: true
      cluster_permissions:
        - 'cluster:admin/knn_training_model_action'
        - 'cluster:admin/knn_training_job_router_action'
        - 'cluster:admin/knn_training_job_route_decision_info_action'
        - 'cluster:admin/knn_warmup_action'
        - 'cluster:admin/knn_delete_model_action'
        - 'cluster:admin/knn_remove_model_from_cache_action'
        - 'cluster:admin/knn_update_model_graveyard_action'
        - 'cluster:admin/knn_search_model_action'
        - 'cluster:admin/knn_get_model_action'
        - 'cluster:admin/knn_stats_action'

    # Allow users to execute read only ip2geo datasource action
    ip2geo_datasource_read_access:
      reserved: true
      cluster_permissions:
        - 'cluster:admin/geospatial/datasource/get'

    # Allow users to use all ip2geo datasource action
    ip2geo_datasource_full_access:
      reserved: true
      cluster_permissions:
        - 'cluster:admin/geospatial/datasource/*'

    # Allows users to read Notebooks
    notebooks_read_access:
      reserved: true
      cluster_permissions:
        - 'cluster:admin/opendistro/notebooks/list'
        - 'cluster:admin/opendistro/notebooks/get'

    # Allows users to all Notebooks functionality
    notebooks_full_access:
      reserved: true
      cluster_permissions:
        - 'cluster:admin/opendistro/notebooks/create'
        - 'cluster:admin/opendistro/notebooks/update'
        - 'cluster:admin/opendistro/notebooks/delete'
        - 'cluster:admin/opendistro/notebooks/get'
        - 'cluster:admin/opendistro/notebooks/list'

    # Allows users to read observability objects
    observability_read_access:
      reserved: true
      cluster_permissions:
        - 'cluster:admin/opensearch/observability/get'

    # Allows users to all Observability functionality
    observability_full_access:
      reserved: true
      cluster_permissions:
        - 'cluster:admin/opensearch/observability/create'
        - 'cluster:admin/opensearch/observability/update'
        - 'cluster:admin/opensearch/observability/delete'
        - 'cluster:admin/opensearch/observability/get'

    # Allows users to all PPL functionality
    ppl_full_access:
      reserved: true
      cluster_permissions:
        - 'cluster:admin/opensearch/ppl'
      index_permissions:
        - index_patterns:
            - '*'
          allowed_actions:
            - 'indices:admin/mappings/get'
            - 'indices:data/read/search*'
            - 'indices:monitor/settings/get'

    # Allows users to read and download Reports
    reports_instances_read_access:
      reserved: true
      cluster_permissions:
        - 'cluster:admin/opendistro/reports/instance/list'
        - 'cluster:admin/opendistro/reports/instance/get'
        - 'cluster:admin/opendistro/reports/menu/download'

    # Allows users to read and download Reports and Report-definitions
    reports_read_access:
      reserved: true
      cluster_permissions:
        - 'cluster:admin/opendistro/reports/definition/get'
        - 'cluster:admin/opendistro/reports/definition/list'
        - 'cluster:admin/opendistro/reports/instance/list'
        - 'cluster:admin/opendistro/reports/instance/get'
        - 'cluster:admin/opendistro/reports/menu/download'

    # Allows users to all Reports functionality
    reports_full_access:
      reserved: true
      cluster_permissions:
        - 'cluster:admin/opendistro/reports/definition/create'
        - 'cluster:admin/opendistro/reports/definition/update'
        - 'cluster:admin/opendistro/reports/definition/on_demand'
        - 'cluster:admin/opendistro/reports/definition/delete'
        - 'cluster:admin/opendistro/reports/definition/get'
        - 'cluster:admin/opendistro/reports/definition/list'
        - 'cluster:admin/opendistro/reports/instance/list'
        - 'cluster:admin/opendistro/reports/instance/get'
        - 'cluster:admin/opendistro/reports/menu/download'

    # Allows users to use all asynchronous-search functionality
    asynchronous_search_full_access:
      reserved: true
      cluster_permissions:
        - 'cluster:admin/opendistro/asynchronous_search/*'
      index_permissions:
        - index_patterns:
            - '*'
          allowed_actions:
            - 'indices:data/read/search*'

    # Allows users to read stored asynchronous-search results
    asynchronous_search_read_access:
      reserved: true
      cluster_permissions:
        - 'cluster:admin/opendistro/asynchronous_search/get'

    # Allows user to use all index_management actions - ism policies, rollups, transforms
    index_management_full_access:
      reserved: true
      cluster_permissions:
        - "cluster:admin/opendistro/ism/*"
        - "cluster:admin/opendistro/rollup/*"
        - "cluster:admin/opendistro/transform/*"
        - "cluster:admin/opensearch/controlcenter/lron/*"
        - "cluster:admin/opensearch/notifications/channels/get"
        - "cluster:admin/opensearch/notifications/feature/publish"
        - "cluster:admin/opensearch/templates/*"
        - "cluster:admin/opensearch/index_template/*"
      index_permissions:
        - index_patterns:
            - '*'
          allowed_actions:
            - 'indices:admin/opensearch/ism/*'

    # Allows users to use all cross cluster replication functionality at leader cluster
    cross_cluster_replication_leader_full_access:
      reserved: true
      index_permissions:
        - index_patterns:
            - '*'
          allowed_actions:
            - "indices:admin/plugins/replication/index/setup/validate"
            - "indices:data/read/plugins/replication/changes"
            - "indices:data/read/plugins/replication/file_chunk"

    # Allows users to use all cross cluster replication functionality at follower cluster
    cross_cluster_replication_follower_full_access:
      reserved: true
      cluster_permissions:
        - "cluster:admin/plugins/replication/autofollow/update"
      index_permissions:
        - index_patterns:
            - '*'
          allowed_actions:
            - "indices:admin/plugins/replication/index/setup/validate"
            - "indices:data/write/plugins/replication/changes"
            - "indices:admin/plugins/replication/index/start"
            - "indices:admin/plugins/replication/index/pause"
            - "indices:admin/plugins/replication/index/resume"
            - "indices:admin/plugins/replication/index/stop"
            - "indices:admin/plugins/replication/index/update"
            - "indices:admin/plugins/replication/index/status_check"

    # Allows users to use all cross cluster search functionality at remote cluster
    cross_cluster_search_remote_full_access:
      reserved: true
      index_permissions:
        - index_patterns:
            - '*'
          allowed_actions:
            - 'indices:admin/shards/search_shards'
            - 'indices:data/read/search'

    # Allow users to read ML stats/models/tasks
    ml_read_access:
      reserved: true
      cluster_permissions:
        - 'cluster:admin/opensearch/ml/stats/nodes'
        - 'cluster:admin/opensearch/ml/model_groups/search'
        - 'cluster:admin/opensearch/ml/models/get'
        - 'cluster:admin/opensearch/ml/models/search'
        - 'cluster:admin/opensearch/ml/tasks/get'
        - 'cluster:admin/opensearch/ml/tasks/search'

    # Allows users to use all ML functionality
    ml_full_access:
      reserved: true
      cluster_permissions:
        - 'cluster_monitor'
        - 'cluster:admin/opensearch/ml/*'
      index_permissions:
        - index_patterns:
            - '*'
          allowed_actions:
            - 'indices_monitor'

    # Allows users to use all Notifications functionality
    notifications_full_access:
      reserved: true
      cluster_permissions:
        - 'cluster:admin/opensearch/notifications/*'

    # Allows users to read Notifications config/channels
    notifications_read_access:
      reserved: true
      cluster_permissions:
        - 'cluster:admin/opensearch/notifications/configs/get'
        - 'cluster:admin/opensearch/notifications/features'
        - 'cluster:admin/opensearch/notifications/channels/get'

    # Allows users to use all snapshot management functionality
    snapshot_management_full_access:
      reserved: true
      cluster_permissions:
        - 'cluster:admin/opensearch/snapshot_management/*'
        - 'cluster:admin/opensearch/notifications/feature/publish'
        - 'cluster:admin/repository/*'
        - 'cluster:admin/snapshot/*'

    # Allows users to see snapshots, repositories, and snapshot management policies
    snapshot_management_read_access:
      reserved: true
      cluster_permissions:
        - 'cluster:admin/opensearch/snapshot_management/policy/get'
        - 'cluster:admin/opensearch/snapshot_management/policy/search'
        - 'cluster:admin/opensearch/snapshot_management/policy/explain'
        - 'cluster:admin/repository/get'
        - 'cluster:admin/snapshot/get'

    # Allows user to use point in time functionality
    point_in_time_full_access:
      reserved: true
      index_permissions:
        - index_patterns:
            - '*'
          allowed_actions:
            - 'manage_point_in_time'

    # Allows users to see security analytics detectors and others
    security_analytics_read_access:
      reserved: true
      cluster_permissions:
        - 'cluster:admin/opensearch/securityanalytics/alerts/get'
        - 'cluster:admin/opensearch/securityanalytics/correlations/findings'
        - 'cluster:admin/opensearch/securityanalytics/correlations/list'
        - 'cluster:admin/opensearch/securityanalytics/detector/get'
        - 'cluster:admin/opensearch/securityanalytics/detector/search'
        - 'cluster:admin/opensearch/securityanalytics/findings/get'
        - 'cluster:admin/opensearch/securityanalytics/mapping/get'
        - 'cluster:admin/opensearch/securityanalytics/mapping/view/get'
        - 'cluster:admin/opensearch/securityanalytics/rule/get'
        - 'cluster:admin/opensearch/securityanalytics/rule/search'

    # Allows users to use all security analytics functionality
    security_analytics_full_access:
      reserved: true
      cluster_permissions:
        - 'cluster:admin/opensearch/securityanalytics/alerts/*'
        - 'cluster:admin/opensearch/securityanalytics/correlations/*'
        - 'cluster:admin/opensearch/securityanalytics/detector/*'
        - 'cluster:admin/opensearch/securityanalytics/findings/*'
        - 'cluster:admin/opensearch/securityanalytics/mapping/*'
        - 'cluster:admin/opensearch/securityanalytics/rule/*'
      index_permissions:
        - index_patterns:
            - '*'
          allowed_actions:
            - 'indices:admin/mapping/put'
            - 'indices:admin/mappings/get'

    # Allows users to view and acknowledge alerts
    security_analytics_ack_alerts:
      reserved: true
      cluster_permissions:
        - 'cluster:admin/opensearch/securityanalytics/alerts/*'

    # Wazuh monitoring and statistics index permissions
    manage_wazuh_index:
      reserved: true
      hidden: false
      cluster_permissions: []
      index_permissions:
        - index_patterns:
            - "wazuh-*"
          dls: ""
          fls: []
          masked_fields: []
          allowed_actions:
            - "read"
            - "delete"
            - "manage"
            - "index"
      tenant_permissions: []
      static: false

  config.yml: |-
    ---

    _meta:
      type: "config"
      config_version: 2

    config:
      dynamic:
        # Set filtered_alias_mode to 'disallow' to forbid more than 2 filtered aliases per index
        # Set filtered_alias_mode to 'warn' to allow more than 2 filtered aliases per index but warns about it (default)
        # Set filtered_alias_mode to 'nowarn' to allow more than 2 filtered aliases per index silently
        #filtered_alias_mode: warn
        #do_not_fail_on_forbidden: false
        #kibana:
        # Kibana multitenancy
        #multitenancy_enabled: true
        #private_tenant_enabled: true
        #default_tenant: ""
        #server_username: kibanaserver
        #index: '.kibana'
        http:
          anonymous_auth_enabled: false
          xff:
            enabled: false
            internalProxies: '192\.168\.0\.10|192\.168\.0\.11' # regex pattern
            #internalProxies: '.*' # trust all internal proxies, regex pattern
            #remoteIpHeader:  'x-forwarded-for'
        authc:
    {{- if .Values.dashboard.sso.oidc.enabled }}
          openid_auth_domain:
            http_enabled: true
            transport_enabled: true
            order: {{ .Values.dashboard.sso.oidc.order }}
            http_authenticator:
              type: openid
              challenge: {{ not .Values.dashboard.sso.oidc.primary }}
              config:
                subject_key: {{ .Values.dashboard.sso.oidc.config.subjectKey }}
                roles_key: {{ .Values.dashboard.sso.oidc.config.rolesKey }}
                openid_connect_url: {{ .Values.dashboard.sso.oidc.url }}
                {{- with .Values.dashboard.sso.oidc.issuer }}
                required_issuer: {{ . }}
                {{- end }}
                {{- if .Values.dashboard.sso.oidc.idp.enableSSL }}
                openid_connect_idp:
                  enable_ssl: {{ .Values.dashboard.sso.oidc.idp.enableSSL }}
                  {{- if and (.Values.dashboard.sso.oidc.idp.pemtrustedcasFilePath) (not .Values.dashboard.sso.oidc.idp.pemtrustedcasContent) }}
                  pemtrustedcas_filepath: {{ .Values.dashboard.sso.oidc.idp.pemtrustedcasFilePath }}
                  {{- end }}
                  {{- if and (.Values.dashboard.sso.oidc.idp.pemtrustedcasContent) (not .Values.dashboard.sso.oidc.idp.pemtrustedcasFilePath) }}
                  pemtrustedcas_content: |-
                    {{- .Values.dashboard.sso.oidc.idp.pemtrustedcasContent | nindent 20 }}
                  {{- end }}
                {{- end }}
                client_id: ${env.OPENSEARCH_OIDC_CLIENT_ID}
                client_secret: ${env.OPENSEARCH_OIDC_CLIENT_SECRET}
            authentication_backend:
              type: noop
    {{- end }}
    {{- if .Values.dashboard.sso.saml.enabled }}
          saml_auth_domain:
            http_enabled: true
            transport_enabled: false
            order: {{ .Values.dashboard.sso.saml.order }}
            http_authenticator:
              type: saml
              challenge: {{ not .Values.dashboard.sso.saml.primary }}
              config:
                idp:
                  {{- if .Values.dashboard.sso.saml.enableSSL }}
                  enable_ssl: {{ .Values.dashboard.sso.saml.enableSSL }}
                  {{- if and (.Values.dashboard.sso.saml.pemtrustedcasFilePath) (not .Values.dashboard.sso.saml.pemtrustedcasContent) }}
                  pemtrustedcas_filepath: {{ .Values.dashboard.sso.saml.pemtrustedcasFilePath }}
                  {{- end }}
                  {{- if and (.Values.dashboard.sso.saml.pemtrustedcasContent) (not .Values.dashboard.sso.saml.pemtrustedcasFilePath) }}
                  pemtrustedcas_content: |-
                    {{- .Values.dashboard.sso.saml.pemtrustedcasContent | nindent 20 }}
                  {{- end }}
                  {{- end }}
                  metadata_url: {{ required "dashboard.sso.saml.metadataUrl is required" .Values.dashboard.sso.saml.metadataUrl }}
                  entity_id: {{ required "dashboard.sso.saml.idpEntityId is required" .Values.dashboard.sso.saml.idpEntityId }}
                sp:
                  entity_id: {{ .Values.dashboard.sso.saml.spEntityId }}
                kibana_url: {{ .Values.dashboard.sso.saml.kibanaUrl | default (printf "https://%s" .Values.dashboard.ingress.host) | required "dashboard.sso.saml.kibanaUrl or dashboard.ingress.host is required" }}
                roles_key: {{ .Values.dashboard.sso.saml.config.rolesKey }}
                exchange_key: {{ required "dashboard.sso.saml.exchangeKey is required" .Values.dashboard.sso.saml.exchangeKey }}
            authentication_backend:
              type: noop
    {{- end }}
          kerberos_auth_domain:
            http_enabled: false
            transport_enabled: false
            order: 6
            http_authenticator:
              type: kerberos
              challenge: true
              config:
                krb_debug: false
                strip_realm_from_principal: true
            authentication_backend:
              type: noop
          basic_internal_auth_domain:
            description: "Authenticate via HTTP Basic against internal users database"
            http_enabled: true
            transport_enabled: true
            order: {{ .Values.dashboard.basicAuth.order }}
            http_authenticator:
              type: basic
              challenge: {{ .Values.dashboard.basicAuth.challenge }}
            authentication_backend:
              type: intern
          proxy_auth_domain:
            description: "Authenticate via proxy"
            http_enabled: false
            transport_enabled: false
            order: 3
            http_authenticator:
              type: proxy
              challenge: false
              config:
                user_header: "x-proxy-user"
                roles_header: "x-proxy-roles"
            authentication_backend:
              type: noop
          jwt_auth_domain:
            description: "Authenticate via Json Web Token"
            http_enabled: false
            transport_enabled: false
            order: 4
            http_authenticator:
              type: jwt
              challenge: false
              config:
                signing_key: "base64 encoded HMAC key or public RSA/ECDSA pem key"
                jwt_header: "Authorization"
                jwt_url_parameter: null
                jwt_clock_skew_tolerance_seconds: 30
                roles_key: null
                subject_key: null
            authentication_backend:
              type: noop
          clientcert_auth_domain:
            description: "Authenticate via SSL client certificates"
            http_enabled: false
            transport_enabled: false
            order: 2
            http_authenticator:
              type: clientcert
              config:
                username_attribute: cn #optional, if omitted DN becomes username
              challenge: false
            authentication_backend:
              type: noop
      {{- if .Values.indexer.ldap.enabled }}
          ldap:
            description: "Authenticate via LDAP or Active Directory"
            http_enabled: true
            transport_enabled: true
            order: {{ .Values.indexer.ldap.order }}
            http_authenticator:
              type: basic
              challenge: false
            authentication_backend:
              type: ldap
              config:
                enable_ssl: {{ .Values.indexer.ldap.enableSSL }}
                enable_start_tls: {{ .Values.indexer.ldap.enableStartTLS }}
                enable_ssl_client_auth: {{ .Values.indexer.ldap.enableSSLClientAuth }}
                verify_hostnames: {{ .Values.indexer.ldap.verifyHostnames }}
                hosts:
                  {{- toYaml .Values.indexer.ldap.hosts | nindent 18 }}
                bind_dn: {{ .Values.indexer.ldap.bindDn | default "null" }}
                password: {{ if .Values.indexer.ldap.existingSecret }}${env.OPENSEARCH_LDAP_BIND_PASSWORD}{{ else }}null{{ end }}
                userbase: {{ .Values.indexer.ldap.userbase | quote }}
                usersearch: {{ .Values.indexer.ldap.usersearch | quote }}
                username_attribute: {{ .Values.indexer.ldap.usernameAttribute | default "null" }}
    {{- else }}
          ldap:
            description: "Authenticate via LDAP or Active Directory"
            http_enabled: false
            transport_enabled: false
            order: 5
            http_authenticator:
              type: basic
              challenge: false
            authentication_backend:
              type: ldap
              config:
                enable_ssl: false
                enable_start_tls: false
                enable_ssl_client_auth: false
                verify_hostnames: true
                hosts:
                  - localhost:8389
                bind_dn: null
                password: null
                userbase: 'ou=people,dc=example,dc=com'
                usersearch: '(sAMAccountName={0})'
                username_attribute: null
    {{- end }}
        authz:
    {{- if .Values.indexer.ldap.authz.enabled }}
          roles_from_myldap:
            description: "Authorize via LDAP or Active Directory"
            http_enabled: true
            transport_enabled: true
            authorization_backend:
              type: ldap
              config:
                enable_ssl: {{ .Values.indexer.ldap.enableSSL }}
                enable_start_tls: {{ .Values.indexer.ldap.enableStartTLS }}
                enable_ssl_client_auth: {{ .Values.indexer.ldap.enableSSLClientAuth }}
                verify_hostnames: {{ .Values.indexer.ldap.verifyHostnames }}
                hosts:
                  {{- if .Values.indexer.ldap.authz.hosts }}
                  {{- toYaml .Values.indexer.ldap.authz.hosts | nindent 18 }}
                  {{- else }}
                  {{- toYaml .Values.indexer.ldap.hosts | nindent 18 }}
                  {{- end }}
                bind_dn: {{ .Values.indexer.ldap.authz.bindDn | default "null" }}
                password: {{ if .Values.indexer.ldap.authz.existingSecret }}${env.OPENSEARCH_LDAP_AUTHZ_BIND_PASSWORD}{{ else if .Values.indexer.ldap.existingSecret }}${env.OPENSEARCH_LDAP_BIND_PASSWORD}{{ else }}null{{ end }}
                rolebase: {{ .Values.indexer.ldap.authz.rolebase | quote }}
                rolesearch: {{ .Values.indexer.ldap.authz.rolesearch | quote }}
                userroleattribute: {{ .Values.indexer.ldap.authz.userroleattribute | default "null" }}
                userrolename: {{ .Values.indexer.ldap.authz.userrolename }}
                rolename: {{ .Values.indexer.ldap.authz.rolename }}
                resolve_nested_roles: {{ .Values.indexer.ldap.authz.resolveNestedRoles }}
                userbase: {{ .Values.indexer.ldap.authz.userbase | quote }}
                usersearch: {{ .Values.indexer.ldap.authz.usersearch | quote }}
    {{- else }}
          roles_from_myldap:
            description: "Authorize via LDAP or Active Directory"
            http_enabled: false
            transport_enabled: false
            authorization_backend:
              type: ldap
              config:
                enable_ssl: false
                enable_start_tls: false
                enable_ssl_client_auth: false
                verify_hostnames: true
                hosts:
                  - localhost:8389
                bind_dn: null
                password: null
                rolebase: 'ou=groups,dc=example,dc=com'
                rolesearch: '(member={0})'
                userroleattribute: null
                userrolename: disabled
                rolename: cn
                resolve_nested_roles: true
                userbase: 'ou=people,dc=example,dc=com'
                usersearch: '(uid={0})'
          roles_from_another_ldap:
            description: "Authorize via another Active Directory"
            http_enabled: false
            transport_enabled: false
            authorization_backend:
              type: ldap
              #config goes here ...
    {{- end }}
{{- end }}
